# since the only way to get updated Mono packages is to use Xamarin, we have to set our language differently
language: csharp

addons:
    apt:
        sources:
            # gdc build dependencies
            - debian-sid

        packages:
            # gdc build dependencies
            - build-essential
            - g++-multilib

install:
    # download DepotDownloader source
    - git clone https://github.com/SteamRE/DepotDownloader.git $TRAVIS_BUILD_DIR/DepotDownloader

    # restore NuGet packages
    - cd $TRAVIS_BUILD_DIR/DepotDownloader && nuget restore DepotDownloader.sln

    # build DepotDownloader
    - cd $TRAVIS_BUILD_DIR/DepotDownloader && xbuild /p:NoWarn=1584 DepotDownloader.sln /target:DepotDownloader

    # download TF2 binaries
    - mkdir $TRAVIS_BUILD_DIR/srcds && cd $TRAVIS_BUILD_DIR && mono $TRAVIS_BUILD_DIR/DepotDownloader/DepotDownloader/bin/Debug/DepotDownloader.exe -app 232250 -dir $TRAVIS_BUILD_DIR/srcds -filelist $TRAVIS_BUILD_DIR/server-binaries.txt -all-platforms

    # download SourceMod, which includes gdc
    - git clone --recursive https://github.com/alliedmodders/sourcemod.git $TRAVIS_BUILD_DIR/sourcemod

    # make sure gdc can see the SourcePawn include files
    - ln -s $TRAVIS_BUILD_DIR/sourcemod/sourcepawn/include $TRAVIS_BUILD_DIR/sourcemod/public/sourcepawn

    # properly configure gdc to build successfully
    - export CFLAGS="-Wno-unused-but-set-variable -std=c++0x"

    # build gdc
    - cd $TRAVIS_BUILD_DIR/sourcemod/tools/gdc-psyfork && make

    # download CompCtrl
    - git clone https://github.com/fwdcp/CompCtrl.git $TRAVIS_BUILD_DIR/CompCtrl

script:
    # display the current version of SRCDS
    - cat $TRAVIS_BUILD_DIR/srcds/tf/steam.inf

    # test CompCtrl gamedata
    - cd $TRAVIS_BUILD_DIR && LD_LIBRARY_PATH=$TRAVIS_BUILD_DIR/srcds/bin/ $TRAVIS_BUILD_DIR/sourcemod/tools/gdc-psyfork/Release/gdc -g tf -e ep2v -f $TRAVIS_BUILD_DIR/CompCtrl/gamedata/compctrl.txt -b $TRAVIS_BUILD_DIR/srcds/tf/bin/server_srv.so -x $TRAVIS_BUILD_DIR/srcds/bin/engine_srv.so -w $TRAVIS_BUILD_DIR/srcds/tf/bin/server.dll -y $TRAVIS_BUILD_DIR/srcds/bin/engine.dll
